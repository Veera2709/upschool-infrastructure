name: Deployment

on:
  push:
    branches:
      - dev

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.5.3
      with:
        ssh-private-key: ${{ secrets.AZURE_VM_SSH_KEY }}

    - name: Deploy to Azure VM
      run: |
        ssh -o StrictHostKeyChecking=no abodoo@20.77.56.119 << 'EOF'
          if [ -d "/home/abodoo/api/skill_extractor_app-main/.git" ]; then
            cd /home/abodoo/api/skill_extractor_app-main || { echo "Failed to navigate to project directory"; exit 1; }
            git pull origin main || { echo "Git pull failed"; exit 1; }
          else
            cd /home/abodoo/api/skill_extractor_app-main
            git clone https://github.com/abodooteam/skill_extractor_app.git . || { echo "Git clone failed"; exit 1; }
          fi
          git status || { echo "Failed to check Git status"; exit 1; }
          sudo systemctl daemon-reload || { echo "Systemctl daemon-reload failed"; exit 1; }
          sudo systemctl restart nginx || { echo "Systemctl restart nginx failed"; exit 1; }
        EOF

